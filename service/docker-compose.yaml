  version: "3.6"


  services:
    db:
      image: mysql:latest
      container_name: lemon-db
      ports:
      - 3306:3306
      environment:
      - MYSQL_ROOT_PASSWORD=123456
      - TZ=Asia/Shanghai
      volumes:
      - db-init-volume:/docker-entrypoint-initdb.d
      - db-data-volume:/var/lib/mysql
      - db-log-volume:/var/log/mysql

    nginx:
      image: nginx:latest
      container_name: lemon-ngx
      ports:
        - 7999:80
      volumes:
        - ngx-res-volume:/usr/share/nginx/html
        - ngx-conf-volume:/etc/nginx/conf
        - ngx-log-volume:/var/log/nginx

    discovery:
      image: alpine:latest
      container_name: lemon-disc
      ports:
        - 7171:7171
      volumes:
        - disc-data-volume:/mnt
      command: /bin/sh -c  "cd /mnt && ./discovery -conf discovery-example.toml"

    account:
      image: alpine:latest
      container_name: lemon-acc
      ports:
        - 8000:8000
      environment:
        - DISCOVERY_NODES=lemon-disc:7171
      volumes:
        - account-data-volume:/mnt
      command: /bin/sh -c "cd /mnt && sh wait-for-it.sh -d 'lemon-db:3306' -c './cmd -conf configs/'"
      depends_on:
        - discovery

  volumes:
    ngx-res-volume:
      external: true
    ngx-conf-volume:
      external: true
    ngx-log-volume:
      external: true

    db-data-volume:
      external: true
    db-log-volume:
      external: true
    db-init-volume:
      external: true
    disc-data-volume:
      external: true
    account-data-volume:
      external: true

  networks:
    default:
      external:
        name: lemonhub